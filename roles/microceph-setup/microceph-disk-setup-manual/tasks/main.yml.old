---
# - name: Fail if no disks are specified
#   fail:
#     msg: "No disks specified for MicroCeph. Please add disks_to_add list to inventory."
#   when: disks_to_add | length == 0

# - name: Add disks to MicroCeph
#   command: "microceph disk add {{ item }} {{ '--wipe' if wipe_disks else '' }}"
#   loop: "{{ disks_to_add }}"
#   register: disk_add_result
#   changed_when: "'already added' not in disk_add_result.stderr"
#   failed_when:
#     - disk_add_result.rc != 0
#     - "'already added' not in disk_add_result.stderr"


- name: Check if MicroCeph database is initialized
  command: "microceph status"
  register: microceph_status
  failed_when: microceph_status.rc != 0
  changed_when: false

- name: Fail if database is not initialized
  fail:
    msg: "MicroCeph database is not initialized yet. Initialize the cluster first."
  when: "'Database is not yet initialized' in microceph_status.stderr"

- name: Fail if no disks are specified
  fail:
    msg: "No disks specified for MicroCeph. Please add disks_to_add list to inventory."
  when: disks_to_add | length == 0

- name: Add disks to MicroCeph
  command: "microceph disk add {{ item }} {{ '--wipe' if wipe_disks else '' }}"
  loop: "{{ disks_to_add }}"
  register: disk_add_result
  changed_when: "'already added' not in disk_add_result.stderr"
  failed_when:
    - disk_add_result.rc != 0
    - "'already added' not in disk_add_result.stderr"
